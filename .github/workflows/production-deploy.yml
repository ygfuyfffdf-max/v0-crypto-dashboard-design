name: ğŸš€ Production Deployment Pipeline

on:
  push:
    branches: [main, feature/3d-integration-panels]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Pre-Deploy Verification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pre-deploy-checks:
    name: ğŸ” Pre-Deploy Verification
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: ğŸ—‚ï¸ Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ”„ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Verify environment variables
        run: |
          echo "âœ“ Verificando variables de entorno..."
          if [ -z "${{ secrets.TURSO_DATABASE_URL }}" ]; then
            echo "âŒ TURSO_DATABASE_URL no estÃ¡ configurado"
            exit 1
          fi
          if [ -z "${{ secrets.TURSO_AUTH_TOKEN }}" ]; then
            echo "âŒ TURSO_AUTH_TOKEN no estÃ¡ configurado"
            exit 1
          fi
          echo "âœ… Variables de entorno OK"

      - name: ğŸ” Run ESLint
        run: pnpm lint
        continue-on-error: false

      - name: ğŸ“˜ Run TypeScript type check
        run: pnpm type-check
        continue-on-error: false

      - name: ğŸ§ª Run unit tests
        run: pnpm test --passWithNoTests
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL || 'file:./test.db' }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN || '' }}
        continue-on-error: false

      - name: ğŸ—ï¸ Build application
        run: pnpm build
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          NEXT_PUBLIC_APP_URL: https://v0-crypto-dashboard-design-alpha.vercel.app
        continue-on-error: false

      - name: âœ… All pre-deploy checks passed
        run: echo "ğŸ‰ Â¡Todas las verificaciones pasaron! Listo para deploy."

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Deploy to Vercel
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    needs: pre-deploy-checks
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: ./
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

      - name: ğŸ“Š Deployment URL
        run: |
          echo "âœ… Deploy exitoso!"
          echo "ğŸ”— URL: ${{ steps.vercel-deploy.outputs.preview-url }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Post-Deploy Verification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  post-deploy-checks:
    name: ğŸ” Post-Deploy Verification
    needs: deploy-vercel
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Verificando /api/health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://v0-crypto-dashboard-design-alpha.vercel.app/api/health)
          if [ "$RESPONSE" -eq 200 ]; then
            echo "âœ… Health check OK (200)"
          else
            echo "âŒ Health check FAIL ($RESPONSE)"
            exit 1
          fi

      - name: ğŸ§ª API Endpoint Checks
        run: |
          echo "ğŸ§ª Verificando endpoints crÃ­ticos..."

          # Verificar /api/bancos
          BANCOS=$(curl -s https://v0-crypto-dashboard-design-alpha.vercel.app/api/bancos)
          if echo "$BANCOS" | grep -q "success"; then
            echo "âœ… /api/bancos OK"
          else
            echo "âŒ /api/bancos FAIL"
            exit 1
          fi

          # Verificar /api/clientes
          CLIENTES=$(curl -s https://v0-crypto-dashboard-design-alpha.vercel.app/api/clientes)
          if echo "$CLIENTES" | grep -q "success"; then
            echo "âœ… /api/clientes OK"
          else
            echo "âŒ /api/clientes FAIL"
            exit 1
          fi

      - name: âœ… Production verification complete
        run: echo "ğŸ‰ Â¡Sistema operacional en producciÃ³n!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Notify on Failure
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-failure:
    name: ğŸ“¢ Notify on Failure
    needs: [pre-deploy-checks, deploy-vercel, post-deploy-checks]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¢ Send notification
        run: |
          echo "âŒ Pipeline fallÃ³. Revisar logs en:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
