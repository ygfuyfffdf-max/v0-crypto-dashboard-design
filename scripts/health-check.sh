#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ฅ CHRONOS - HEALTH CHECK AVANZADO
# Verificaciรณn completa del estado del proyecto
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

echo "๐ฅ CHRONOS - Health Check del Proyecto"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ERRORS=0
WARNINGS=0

check_pass() {
  echo -e "${GREEN}โ${NC} $1"
}

check_fail() {
  echo -e "${RED}โ${NC} $1"
  ((ERRORS++))
}

check_warn() {
  echo -e "${YELLOW}โ${NC} $1"
  ((WARNINGS++))
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ฆ DEPENDENCIAS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐ฆ Verificando dependencias...${NC}"

if [ -d "node_modules" ]; then
  check_pass "node_modules presente"
else
  check_fail "node_modules no encontrado (ejecutar: pnpm install)"
fi

if [ -f "pnpm-lock.yaml" ]; then
  check_pass "pnpm-lock.yaml presente"
else
  check_warn "pnpm-lock.yaml no encontrado"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ง CONFIGURACIรN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐ง Verificando configuraciรณn...${NC}"

configs=(
  "package.json"
  "tsconfig.json"
  "next.config.ts"
  "tailwind.config.ts"
  ".eslintrc.json"
  ".prettierrc.json"
)

for config in "${configs[@]}"; do
  if [ -f "$config" ]; then
    check_pass "$config presente"
  else
    check_fail "$config no encontrado"
  fi
done

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ SEGURIDAD
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐ Verificando seguridad...${NC}"

if [ -f ".env.local" ]; then
  check_pass ".env.local presente"

  # Verificar que no estรฉ en git
  if git ls-files --error-unmatch .env.local 2>/dev/null; then
    check_fail ".env.local estรก rastreado en git (agregar a .gitignore)"
  else
    check_pass ".env.local no estรก rastreado en git"
  fi
else
  check_warn ".env.local no encontrado (copiar de .env.example)"
fi

# Verificar secrets hardcodeados
if grep -r "sk-" --include="*.ts" --include="*.tsx" --include="*.js" app/ 2>/dev/null | grep -v ".env"; then
  check_fail "Posibles API keys hardcodeadas encontradas"
else
  check_pass "No se encontraron secrets hardcodeados"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ TYPESCRIPT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐ Verificando TypeScript...${NC}"

if pnpm type-check 2>/dev/null; then
  check_pass "TypeScript compila sin errores"
else
  check_warn "TypeScript tiene advertencias (ejecutar: pnpm type-check)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ LINTING
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐ Verificando linting...${NC}"

if pnpm lint --quiet 2>/dev/null; then
  check_pass "ESLint sin errores"
else
  check_warn "ESLint reporta advertencias (ejecutar: pnpm lint)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐๏ธ BUILD
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐๏ธ Verificando build...${NC}"

if [ -d ".next" ]; then
  check_pass "Build de Next.js presente"
else
  check_warn "Build no encontrado (ejecutar: pnpm build)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐๏ธ BASE DE DATOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${BLUE}๐๏ธ Verificando base de datos...${NC}"

if [ -d "database" ]; then
  check_pass "Directorio database presente"

  if [ -f "database/sqlite.db" ]; then
    check_pass "Base de datos SQLite presente"
  else
    check_warn "Base de datos SQLite no encontrada (ejecutar: pnpm db:push)"
  fi
else
  check_warn "Directorio database no encontrado"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ RESUMEN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${BLUE}๐ RESUMEN${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
  echo -e "${GREEN}โ Proyecto en perfecto estado${NC}"
elif [ $ERRORS -eq 0 ]; then
  echo -e "${YELLOW}โ๏ธ Proyecto con $WARNINGS advertencia(s)${NC}"
else
  echo -e "${RED}โ Proyecto con $ERRORS error(es) y $WARNINGS advertencia(s)${NC}"
fi

echo ""
exit $ERRORS
