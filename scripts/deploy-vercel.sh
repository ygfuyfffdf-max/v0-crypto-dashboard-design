#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHRONOS INFINITY 2026 โ Script de Deployment Completo a Vercel
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ CHRONOS INFINITY 2026 โ Deployment Vercel Production"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Verificar Vercel CLI
if ! command -v vercel &> /dev/null; then
    echo -e "${RED}โ Vercel CLI no estรก instalado${NC}"
    echo "Instalar con: npm install -g vercel"
    exit 1
fi

echo -e "${GREEN}โ Vercel CLI detectado ($(vercel --version))${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 1: VERIFICACIONES PRE-DEPLOYMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASO 1/6: Verificaciones Pre-Deployment"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar archivos crรญticos
echo -n "Verificando archivos crรญticos... "
required_files=(
    "package.json"
    "next.config.ts"
    "vercel.json"
    ".env.example"
    "database/schema.ts"
    "app/_actions/flujos-completos.ts"
    "app/_lib/ai/zero-force-voice.ts"
)

for file in "${required_files[@]}"; do
    if [ ! -f "$file" ]; then
        echo -e "${RED}โ Falta: $file${NC}"
        exit 1
    fi
done
echo -e "${GREEN}โ${NC}"

# Verificar node_modules
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}โ๏ธ  node_modules no encontrado, instalando dependencias...${NC}"
    npm install
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 2: LIMPIEZA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งน PASO 2/6: Limpieza de Build Anterior"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo -n "Limpiando .next... "
rm -rf .next
echo -e "${GREEN}โ${NC}"

echo -n "Limpiando archivos temporales... "
find . -name "*.log" -type f -delete 2>/dev/null || true
echo -e "${GREEN}โ${NC}"

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 3: VERIFICACIรN DE CรDIGO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASO 3/6: Verificaciรณn de Cรณdigo"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# TypeScript check
echo -n "TypeScript check... "
if npm run type-check > /tmp/typecheck.log 2>&1; then
    echo -e "${GREEN}โ 0 errores${NC}"
else
    echo -e "${RED}โ Errores encontrados${NC}"
    cat /tmp/typecheck.log
    echo ""
    read -p "ยฟContinuar de todas formas? (y/N): " continue_anyway
    if [[ ! $continue_anyway =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Lint (opcional, no bloqueante)
echo -n "ESLint check... "
if npm run lint > /tmp/lint.log 2>&1; then
    echo -e "${GREEN}โ${NC}"
else
    echo -e "${YELLOW}โ๏ธ  Warnings (no bloqueante)${NC}"
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 4: LOGIN VERCEL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASO 4/6: Autenticaciรณn Vercel"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar si ya estรก logueado
if vercel whoami > /dev/null 2>&1; then
    current_user=$(vercel whoami)
    echo -e "${GREEN}โ Ya autenticado como: $current_user${NC}"
else
    echo "Iniciando login..."
    vercel login
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 5: LINK PROYECTO (si no estรก linkeado)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASO 5/6: Link Proyecto a Vercel"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ ! -d ".vercel" ]; then
    echo "Proyecto no linkeado, iniciando link..."
    vercel link
else
    echo -e "${GREEN}โ Proyecto ya linkeado${NC}"
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 6: DEPLOYMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASO 6/6: Deployment a Producciรณn"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo -e "${BLUE}Tipo de deployment:${NC}"
echo "1. Preview (rama actual, testing)"
echo "2. Production (deployment final)"
echo ""
read -p "Seleccionar opciรณn (1/2): " deploy_type

case $deploy_type in
    1)
        echo ""
        echo -e "${YELLOW}Deployando Preview...${NC}"
        vercel
        ;;
    2)
        echo ""
        echo -e "${GREEN}Deployando a Production...${NC}"
        echo ""
        read -p "ยฟConfirmar deployment a PRODUCTION? (y/N): " confirm
        if [[ $confirm =~ ^[Yy]$ ]]; then
            vercel --prod
        else
            echo "Deployment cancelado"
            exit 0
        fi
        ;;
    *)
        echo -e "${RED}Opciรณn invรกlida${NC}"
        exit 1
        ;;
esac

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ DEPLOYMENT COMPLETADO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ Prรณximos pasos:"
echo "1. Verificar deployment en Dashboard Vercel"
echo "2. Configurar custom domain (opcional)"
echo "3. Verificar environment variables"
echo "4. Ejecutar health check: curl https://tu-domain/api/health"
echo ""
echo "๐ Dashboard: https://vercel.com/dashboard"
echo ""
